<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smile Hub - Patient Management</title>
<link rel="icon" type="image/x-icon" href="./ico2.png" />
<link rel="stylesheet" href="button-fix.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  :root {
    --primary-color: #000000;
    --secondary-color: #ffffff;
    --accent-color: #6c757d;
    --dark-bg: #0a0c10;
    --darker-bg: #151922;
    --card-bg: rgba(255, 255, 255, 0.08);
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.8);
    --text-muted: rgba(255, 255, 255, 0.6);
    --border-color: rgba(255, 255, 255, 0.1);
    --shadow-light: 0 8px 32px rgba(255, 255, 255, 0.1);
    --gradient-bg: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 50%, #1a1f2e 100%);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
    scroll-behavior: smooth;
  }

  body {
    background: var(--gradient-bg);
    background-attachment: fixed;
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(108, 117, 125, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(52, 58, 64, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
  }

  .navbar {
    backdrop-filter: blur(20px);
    background: rgba(10, 12, 16, 0.9);
    border: 1px solid var(--border-color);
    padding: 1rem 0;
    transition: all 0.3s ease;
    border-radius: 15px;
    margin: 0 1rem 2rem 1rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .navbar-brand {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--secondary-color) !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .navbar-brand:hover {
    transform: scale(1.05);
    color: var(--text-secondary) !important;
  }

  .nav-masthead .nav-link {
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 0.9rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    text-decoration: none;
    border-radius: 8px;
  }

  .nav-masthead .nav-link::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background: var(--secondary-color);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateX(-50%);
  }

  .nav-masthead .nav-link.active,
  .nav-masthead .nav-link:hover {
    color: var(--text-primary);
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.1);
  }

  .nav-masthead .nav-link.active::before,
  .nav-masthead .nav-link:hover::before {
    width: 80%;
  }

  .container-custom {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    position: relative;
    z-index: 1;
  }

  .user-status-card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .user-status-card h4 {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .user-status-card p {
    color: var(--text-secondary);
    margin-bottom: 0;
    font-size: 0.9rem;
  }

  #patientForm {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 3rem;
    margin-bottom: 3rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .form-label {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }

  .form-control {
    background: rgba(10, 12, 16, 0.8);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px 16px;
    border-radius: 10px;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    background: rgba(10, 12, 16, 0.9);
    border-color: var(--secondary-color);
    color: var(--text-primary);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
  }

  .form-control::placeholder {
    color: var(--text-muted);
  }


  .btn-secondary {
    background: #6c757d;
    color: white;
    border: 2px solid #6c757d;
  }

  .btn-secondary:hover {
    background: #5a6268;
    border-color: #5a6268;
    color: white;
    transform: translateY(-2px);
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    border: 2px solid var(--secondary-color);
    color: var(--secondary-color);
    font-weight: 600;
    padding: 12px 30px;
    border-radius: 50px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--secondary-color);
    transition: all 0.6s ease;
    z-index: -1;
  }

  .btn-primary:hover::before {
    left: 0;
  }

  .btn-primary:hover {
    color: var(--primary-color);
    border-color: var(--secondary-color);
    transform: translateY(-2px);
  }

  .btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 12px 30px;
    border-radius: 50px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
  }

  .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border: none;
    color: white;
    font-weight: 500;
    padding: 6px 16px;
    border-radius: 20px;
    transition: all 0.3s ease;
  }

  .btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
  }

  .search {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search input {
    flex: 1;
    min-width: 250px;
    padding: 12px 20px;
    border-radius: 25px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-primary);
    backdrop-filter: blur(10px);
  }

  .search input::placeholder {
    color: var(--text-muted);
  }

  .search button {
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .patient-list {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: transparent;
  }

  thead {
    background: rgba(255, 255, 255, 0.1);
  }

  thead th {
    color: var(--text-primary);
    font-weight: 700;
    padding: 16px 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border-color);
  }

  tbody td {
    padding: 16px 20px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  tbody tr:hover td {
    color: var(--text-primary);
  }

  .patient-details {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 3rem;
    margin-top: 2rem;
    position: relative;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .patient-details h3 {
    color: var(--text-primary);
    font-weight: 700;
    margin-bottom: 2rem;
  }

  .patient-details p {
    color: var(--text-secondary);
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }

  .patient-details strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  .patient-details .btn-sm {
    position: absolute;
    top: 25px;
    right: 25px;
  }

  #editPatientForm {
    padding-top: 60px;
    position: relative;
  }

  #editPatientForm .btn-sm {
    position: static;
    width: 100%;
    margin: 0.25rem 0;
  }

  @media (max-width: 768px) {
    .container-custom {
      padding: 1rem 0.5rem;
    }

    .navbar {
      margin: 0 0.5rem 1rem 0.5rem;
      border-radius: 12px;
      padding: 0.75rem 0;
    }

    .navbar-brand {
      font-size: 1.4rem;
    }

    .nav-masthead .nav-link {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      margin: 0.25rem 0;
    }

    .user-status-card {
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .user-status-card h4 {
      font-size: 1.1rem;
    }

    .user-status-card p {
      font-size: 0.85rem;
    }

    #patientForm {
      padding: 1.5rem 1rem;
      margin-bottom: 2rem;
      border-radius: 15px;
    }

    .form-control {
      padding: 10px 12px;
      font-size: 16px;
    }

    .form-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

      /* Mobile responsive buttons */
    .form-button-container {
      flex-direction: column !important;
      gap: 12px !important;
      margin-top: 20px !important;
    }

    .form-button-container .btn {
      width: 100%;
      min-width: auto;
      font-size: 1rem;
      padding: 14px 0;
    }

    .btn {
      width: 100%;
      padding: 12px 0;
      margin: 0.25rem 0;
      font-size: 0.9rem;
    }

    .btn-success {
      padding: 14px 0;
      font-size: 1rem;
    }

    .search {
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search input {
      min-width: 100%;
      margin-bottom: 0;
      font-size: 16px;
    }

    .search button {
      width: 100%;
      padding: 12px 0;
    }

    .patient-list {
      padding: 1rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      min-width: 600px;
      font-size: 0.85rem;
    }

    thead th {
      padding: 12px 8px;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    tbody td {
      padding: 12px 8px;
      font-size: 0.85rem;
    }

    .patient-details {
      padding: 1.5rem 1rem;
      margin-top: 1.5rem;
      position: relative;
    }

    .patient-details h3 {
      font-size: 1.3rem;
      margin-bottom: 1.5rem;
      padding-top: 2rem;
    }

    .patient-details p {
      font-size: 1rem;
      margin-bottom: 0.8rem;
      line-height: 1.5;
    }

    .patient-details .btn-sm {
      position: static;
      width: 100%;
      margin: 0.25rem 0;
      padding: 10px 0;
    }

    #editPatientForm {
      padding-top: 1rem;
    }

    #editPatientForm .btn-sm {
      position: static;
      width: 100%;
      margin: 0.25rem 0;
    }

    .mb-3 {
      margin-bottom: 1.2rem;
    }

    .btn-danger {
      padding: 6px 12px;
      font-size: 0.8rem;
      white-space: nowrap;
    }
  }

  @media (max-width: 576px) {
    .container-custom {
      padding: 0.5rem 0.25rem;
    }

    .navbar {
      margin: 0 0.25rem 1rem 0.25rem;
    }

    #patientForm {
      padding: 1rem 0.75rem;
    }

    .patient-list {
      padding: 0.75rem;
    }

    .patient-details {
      padding: 1rem 0.75rem;
    }

    table {
      min-width: 550px;
    }

    thead th, tbody td {
      padding: 10px 6px;
      font-size: 0.8rem;
    }

    .btn-danger {
      padding: 4px 8px;
      font-size: 0.75rem;
    }
  }

  @media (max-width: 768px) and (orientation: landscape) {
    .patient-list {
      max-height: 60vh;
      overflow-y: auto;
    }

    #patientForm {
      max-height: 80vh;
      overflow-y: auto;
    }

    .patient-details {
      max-height: 80vh;
      overflow-y: auto;
    }
  }
</style>
</head>
<body class="bg-dark text-white h-100 d-flex flex-column">

<div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
  <header class="mb-4">
    <nav class="navbar navbar-expand-md navbar-dark">
      <div class="container-fluid px-0">
        <h3 class="float-md-start mb-0 navbar-brand mx-3">
          <i class="fas fa-smile me-2"></i>Smile Hub
        </h3>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCover">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-center float-md-end" id="navbarCover">
          <ul class="navbar-nav nav-masthead mb-2 mb-md-0">
            <li class="nav-item">
              <a class="nav-link" href="home.html">
                <i class="fas fa-home me-1"></i>Home
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="patient.html">
                <i class="fas fa-users me-1"></i>Patients
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#contact">
                <i class="fas fa-envelope me-1"></i>Contact
              </a>
            </li>
          </ul>
          <ul class="navbar-nav nav-masthead ms-md-auto mb-2 mb-md-0">
            <li class="nav-item" id="loginNavItem">
              <a class="nav-link" href="login.html">
                <i class="fas fa-sign-in-alt me-1"></i>Login
              </a>
            </li>
            <li class="nav-item d-none" id="userGreetingItem">
              <span class="nav-link" id="userGreetingText" style="color: var(--text-primary); text-transform: uppercase; font-weight: 700;">HELLO, USER</span>
            </li>
            <li class="nav-item d-none" id="logoutNavItem">
              <a class="nav-link" href="#" id="logoutNavLink">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
</div>

<div class="container-custom">
  <div class="user-status-card" id="userStatusCard" style="display: none;">
    <h4 id="currentUserDisplay">Your Personal Patient Database</h4>
    <p>You are viewing and managing your own private patient records. Other users cannot access your data.</p>
  </div>

  <div style="text-align:center; margin-bottom:2rem;">
    <button id="showAddPatientBtn" class="btn btn-success" type="button">
      <i class="fas fa-plus me-2"></i>Add Patient
    </button>
  </div>
  
<form id="patientForm" style="display:none;">
  <div class="mb-3">
    <label class="form-label">Name *</label>
    <input type="text" id="name" class="form-control" required placeholder="Full name" />
  </div>
  <div class="mb-3">
    <label class="form-label">Mobile Number *</label>
    <input type="tel" id="contactNo" class="form-control" required placeholder="10-digit mobile number" pattern="[6-9][0-9]{9}" maxlength="10" />
    <div class="form-text text-muted">Enter 10-digit mobile number starting with 6, 7, 8, or 9</div>
  </div>
  <div class="mb-3">
    <label class="form-label">Email</label>
    <input type="email" id="email" class="form-control" placeholder="Email address" />
  </div>
  <div class="mb-3">
    <label class="form-label">Treatment Type *</label>
    <select id="treatmentType" class="form-control" required>
      <option value="" disabled selected>Select treatment type</option>
      <option value="metal_braces">Metal Braces</option>
      <option value="ceramic_braces">Ceramic Braces</option>
      <option value="clear_aligners">Clear Aligners</option>
      <option value="lingual_braces">Lingual Braces</option>
      <option value="self_ligating_braces">Self-Ligating Braces</option>
      <option value="retainers">Retainers</option>
      <option value="palatal_expander">Palatal Expander</option>
      <option value="space_maintainers">Space Maintainers</option>
      <option value="jaw_surgery">Jaw Surgery</option>
      <option value="denture_prostho">Denture (Prostho)</option>
      <option value="rootcanal_crowns">Root Canal & Crowns</option>
      <option value="other">Other</option>
    </select>
    
    <input type="text" id="otherTreatmentType" class="form-control mt-2" placeholder="Please specify treatment type" style="display:none;" />
  </div>
  <div class="mb-3">
    <label class="form-label">Patient Description</label>
    <textarea id="patientDescription" class="form-control" rows="2" placeholder="Short description"></textarea>
  </div>
  <div class="mb-3">
    <label class="form-label">Treatment Starting Date *</label>
    <input type="date" id="treatmentStart" class="form-control" required />
    <div class="form-text text-muted">Date must be within the last 3 years</div>
  </div>
  <div class="mb-3">
    <label class="form-label">Total Fee (INR)</label>
    <input type="number" id="totalFee" class="form-control" min="0" step="0.01" placeholder="Total fee" />
  </div>
  <div class="mb-3">
    <label class="form-label">Paid Fees (INR)</label>
    <input type="number" id="paidFees" class="form-control" min="0" step="0.01" placeholder="Paid fees" />
  </div>
<div class="form-button-container">
  <button type="button" id="cancelAddPatientBtn" class="btn btn-cancel-fixed">
    <i class="fas fa-times me-1"></i>Cancel
  </button>
  <button type="submit" class="btn btn-save-fixed">
    <i class="fas fa-save me-1"></i>Add Patient
  </button>
</div>

</form>

 <div class="search">
  <input type="text" id="searchInput" placeholder="Search your patients by name..." />
  <button id="searchBtn" type="button" class="btn btn-primary">
    <i class="fas fa-search me-1"></i>Search
  </button>
  <button id="showAllBtn" type="button" class="btn btn-secondary">
    <i class="fas fa-list me-1"></i>Show All
  </button>
</div>


<div class="patient-list">
  <table>
    <thead>
      <tr>
        <th><i class="fas fa-user me-2"></i>Name</th>
        <th><i class="fas fa-mobile-alt me-2"></i>Mobile</th>
        <th><i class="fas fa-rupee-sign me-2"></i>Due Money</th>
        <th><i class="fas fa-cog me-2"></i>Action</th>
      </tr>
    </thead>
    <tbody id="patientTableBody"></tbody>
  </table>
</div>

  <div id="patientDetailsContainer"></div>

  <footer class="mt-auto text-center py-4" id="contact">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6 text-md-start">
          <p class="mb-1">
            <strong><i class="fas fa-smile me-2"></i>Smile Hub</strong> - Professional Patient Management
          </p>
          <p class="mb-0" style="color: var(--text-muted);">Engineered with modern technology for exceptional patient care delivery.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-1" style="color: var(--text-secondary);">
            <i class="fas fa-envelope me-2"></i>support@smilehub.com
          </p>
          <p class="mb-0" style="color: var(--text-muted);">
            <i class="fas fa-copyright me-1"></i>2025 Smile Hub. All rights reserved.
          </p>
        </div>
      </div>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = '/api/patients';

  
  const form = document.getElementById('patientForm');
  const patientTableBody = document.getElementById('patientTableBody');
  const searchInput = document.getElementById('searchInput');
  let patients = [];
  let currentUser = null;

  // TREATMENT TYPE DISPLAY MAPPING
  const treatmentTypeMap = {
    metal_braces: "Metal Braces",
    ceramic_braces: "Ceramic Braces",
    clear_aligners: "Clear Aligners",
    lingual_braces: "Lingual Braces",
    self_ligating_braces: "Self-Ligating Braces",
    retainers: "Retainers",
    palatal_expander: "Palatal Expander",
    space_maintainers: "Space Maintainers",
    jaw_surgery: "Jaw Surgery",
    denture_prostho: "Denture (Prostho)",
    rootcanal_crowns: "Root Canal & Crowns",
    other: "Other"
  };

  function getTreatmentDisplayName(value) {
    return treatmentTypeMap[value] || value || 'N/A';
  }

  async function checkAuthStatus() {
    const loginNavItem = document.getElementById('loginNavItem');
    const userGreetingItem = document.getElementById('userGreetingItem');
    const userGreetingText = document.getElementById('userGreetingText');
    const logoutNavItem = document.getElementById('logoutNavItem');
    const userStatusCard = document.getElementById('userStatusCard');
    const currentUserDisplay = document.getElementById('currentUserDisplay');
    
    try {
      const response = await fetch('/auth/user');
      const data = await response.json();
      
      if (data.authenticated) {
        currentUser = data.user;
        loginNavItem.classList.add('d-none');
        userGreetingItem.classList.remove('d-none');
        logoutNavItem.classList.remove('d-none');
        userGreetingText.textContent = `HELLO, ${(data.user.fullName || data.user.username).toUpperCase()}`;
        
        userStatusCard.style.display = 'block';
        currentUserDisplay.textContent = `${(data.user.fullName || data.user.username)}'s Personal Patient Database`;
        
        await loadPatients();
      } else {
        window.location.href = '/login.html';
      }
    } catch (error) {
      console.error('Auth check failed:', error);
      window.location.href = '/login.html';
    }
  }

  async function handleLogout() {
    try {
      const response = await fetch('/auth/logout', { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        window.location.href = '/login.html';
      } else {
        console.error('Logout failed');
        alert('Logout failed. Please try again.');
      }
    } catch (error) {
      console.error('Logout error:', error);
      alert('Logout failed. Please try again.');
    }
  }

  const today = new Date();
  const threeYearsAgo = new Date(today.getFullYear() - 3, today.getMonth(), today.getDate());
  const treatmentStartInput = document.getElementById('treatmentStart');
  
  treatmentStartInput.min = threeYearsAgo.toISOString().split('T')[0];
  treatmentStartInput.max = today.toISOString().split('T')[0];

  const contactNoInput = document.getElementById('contactNo');
  contactNoInput.addEventListener('input', function() {
    this.value = this.value.replace(/\D/g, '');
    if (this.value.length > 10) {
      this.value = this.value.slice(0, 10);
    }
    
    const isValid = /^[6-9][0-9]{9}$/.test(this.value);
    if (this.value.length === 10 && !isValid) {
      this.setCustomValidity('Mobile number must start with 6, 7, 8, or 9');
    } else if (this.value.length > 0 && this.value.length < 10) {
      this.setCustomValidity('Mobile number must be exactly 10 digits');
    } else {
      this.setCustomValidity('');
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    checkAuthStatus();
    
    const logoutLink = document.getElementById('logoutNavLink');
    if (logoutLink) {
      logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        handleLogout();
      });
    }
  });

  async function loadPatients() {
    try {
      console.log('🔄 Loading patients...');
      
      const response = await fetch('/api/patients', {
        method: 'GET',
        credentials: 'include', // Important for session-based auth
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log('📡 Response status:', response.status);
      console.log('📡 Response headers:', response.headers);
      
      if (!response.ok) {
        console.error('❌ API Error:', response.status, response.statusText);
        return;
      }
      
      const patients = await response.json();
      console.log('📊 Received patients:', patients);
      console.log('📊 Number of patients:', patients.length);
      
      // Display patients in table
      displayPatients(patients);
      
    } catch (error) {
      console.error('❌ Fetch error:', error);
    }
  }

function displayPatients(patients) {
  const tableBody = document.querySelector('#patient-table-body');
  
  if (!patients || patients.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="4">No patients found</td></tr>';
    return;
  }
  
  tableBody.innerHTML = patients.map(patient => `
    <tr>
      <td>${patient.name || 'No name'}</td>
      <td>${patient.contactno || 'Not provided'}</td>
      <td>₹${patient.due_money || 0}</td>
      <td>
        <button class="btn btn-danger" onclick="deletePatient('${patient.id}')">
          Delete
        </button>
      </td>
    </tr>
  `).join('');
}


  async function createPatient(patientData) {
    try {
      const response = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patientData)
      });
      
      if (response.status === 401) {
        window.location.href = '/login.html';
        return null;
      }
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.errors ? error.errors.join(', ') : error.error);
      }
      
      return await response.json();
    } catch (error) {
      alert('Error creating patient: ' + error.message);
      return null;
    }
  }

  async function updatePatient(id, patientData) {
    try {
      const response = await fetch(`${API}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patientData)
      });
      
      if (response.status === 401) {
        window.location.href = '/login.html';
        return null;
      }
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.errors ? error.errors.join(', ') : error.error);
      }
      
      return await response.json();
    } catch (error) {
      alert('Error updating patient: ' + error.message);
      return null;
    }
  }

  async function deletePatient(id) {
    try {
      const response = await fetch(`${API}/${id}`, { method: 'DELETE' });
      if (response.status === 401) {
        window.location.href = '/login.html';
        return false;
      }
      if (!response.ok && response.status !== 404) {
        const error = await response.json();
        throw new Error(error.error);
      }
      return true;
    } catch (error) {
      alert('Error deleting patient: ' + error.message);
      return false;
    }
  }

  function calculateDue(total, paid) {
    const t = parseFloat(total);
    const p = parseFloat(paid);
    if (isNaN(t)) return 0;
    if (isNaN(p)) return t;
    return Math.max(0, t - p).toFixed(2);
  }

  function validateDate(dateString) {
    const selectedDate = new Date(dateString);
    const today = new Date();
    const threeYearsAgo = new Date(today.getFullYear() - 3, today.getMonth(), today.getDate());
    return selectedDate >= threeYearsAgo && selectedDate <= today;
  }

  function renderList(list) {
    patientTableBody.innerHTML = '';
    const patientDetailsContainer = document.getElementById('patientDetailsContainer');
    
    if(list.length === 0){
      patientTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: var(--text-muted); padding: 2rem;">
        ${currentUser ? `No patients found in ${currentUser.fullName || currentUser.username}'s database` : 'No patients found'}
      </td></tr>`;
      patientDetailsContainer.innerHTML = '';
      return;
    }
    
    list.forEach((p, index) => {
      const dueMoney = calculateDue(p.totalFee, p.paidFees);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="cursor:pointer;">${p.name}</td>
        <td style="cursor:pointer;">${p.contactNo || ''}</td>
        <td style="cursor:pointer;">₹${dueMoney}</td>
        <td>
          <button class="btn btn-danger btn-sm delete-patient-btn" data-id="${p.id}">
            <i class="fas fa-trash me-1"></i>Delete
          </button>
        </td>
      `;
      
      Array.from(tr.children).forEach((td, i) => {
        if (i < 3) {
          td.addEventListener('click', () => showDetails(index));
        }
      });
      
      patientTableBody.appendChild(tr);
    });
    
    patientDetailsContainer.innerHTML = '';
    
    document.querySelectorAll('.delete-patient-btn').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        const id = this.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this patient from your database?')) {
          const success = await deletePatient(id);
          if (success) {
            await loadPatients();
          }
        }
      });
    });
  }

  function showDetails(index) {
    const p = patients[index];
    const dueMoney = calculateDue(p.totalFee, p.paidFees);
    const patientDetailsContainer = document.getElementById('patientDetailsContainer');
    
    // USE DISPLAY NAME INSTEAD OF VALUE
    const treatmentDisplayName = getTreatmentDisplayName(p.patientType);
    
    patientDetailsContainer.innerHTML = `
      <div class="patient-details">
        <button id="editBtn" class="btn btn-primary btn-sm" style="position:absolute; top:25px; right:25px;">
          <i class="fas fa-edit me-1"></i>Edit
        </button>
        <h3><i class="fas fa-user-circle me-2"></i>${p.name}</h3>
        <p><strong><i class="fas fa-mobile-alt me-2"></i>Mobile:</strong> ${p.contactNo || 'Not provided'}</p>
        <p><strong><i class="fas fa-envelope me-2"></i>Email:</strong> ${p.email || 'Not provided'}</p>
        <p><strong><i class="fas fa-tooth me-2"></i>Treatment Type:</strong> ${treatmentDisplayName}</p>
        <p><strong><i class="fas fa-notes-medical me-2"></i>Description:</strong> ${p.patientDescription || 'No description'}</p>
        <p><strong><i class="fas fa-calendar-alt me-2"></i>Treatment Start Date:</strong> ${p.treatmentStart || 'Not set'}</p>
        <p><strong><i class="fas fa-rupee-sign me-2"></i>Total Fee:</strong> ₹${p.totalFee || 0}</p>
        <p><strong><i class="fas fa-money-bill-wave me-2"></i>Paid Fees:</strong> ₹${p.paidFees || 0}</p>
        <p><strong><i class="fas fa-exclamation-circle me-2"></i>Due Money:</strong> <span style="color: ${dueMoney > 0 ? '#ff6b6b' : '#51cf66'};">₹${dueMoney}</span></p>
      </div>
    `;
    
    document.getElementById('editBtn').addEventListener('click', function() {
      showEditForm(index);
    });
  }

  function showEditForm(index) {
    const p = patients[index];
    const dueMoney = calculateDue(p.totalFee, p.paidFees);
    const patientDetailsContainer = document.getElementById('patientDetailsContainer');
    
patientDetailsContainer.innerHTML = `
  <form id="editPatientForm" class="patient-details">
    <div class="form-button-container" style="position:absolute; top:25px; right:25px;">
      <button type="button" id="cancelEditBtn" class="btn btn-cancel-fixed btn-sm">
        <i class="fas fa-times me-1"></i>Cancel
      </button>
      <button type="submit" class="btn btn-save-fixed btn-sm">
        <i class="fas fa-save me-1"></i>Save
      </button>
    </div>

        
        <div style="padding-top:60px;">
          <div class="mb-3">
            <label class="form-label"><strong>Name:</strong></label>
            <input type="text" class="form-control" name="name" value="${p.name || ''}" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Mobile:</strong></label>
            <input type="tel" class="form-control" name="contactNo" value="${p.contactNo || ''}" pattern="[6-9][0-9]{9}" maxlength="10">
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Email:</strong></label>
            <input type="email" class="form-control" name="email" value="${p.email || ''}">
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Description:</strong></label>
            <textarea class="form-control" name="patientDescription" rows="2">${p.patientDescription || ''}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Treatment Start Date:</strong></label>
            <input type="date" class="form-control" name="treatmentStart" value="${p.treatmentStart || ''}" min="${threeYearsAgo.toISOString().split('T')[0]}" max="${today.toISOString().split('T')[0]}">
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Total Fee:</strong></label>
            <input type="number" class="form-control" name="totalFee" value="${p.totalFee || 0}" min="0" step="0.01">
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Paid Fees:</strong></label>
            <input type="number" class="form-control" name="paidFees" value="${p.paidFees || 0}" min="0" step="0.01">
          </div>
         <div class="mb-3">
          <label class="form-label"><strong>Treatment Type:</strong></label>
          <select class="form-control" name="treatmentType" required>
            <option value="${p.patientType}" selected>${getTreatmentDisplayName(p.patientType)}</option>
            <option value="metal_braces">Metal Braces</option>
            <option value="ceramic_braces">Ceramic Braces</option>
            <option value="clear_aligners">Clear Aligners</option>
            <option value="lingual_braces">Lingual Braces</option>
            <option value="self_ligating_braces">Self-Ligating Braces</option>
            <option value="retainers">Retainers</option>
            <option value="palatal_expander">Palatal Expander</option>
            <option value="space_maintainers">Space Maintainers</option>
            <option value="jaw_surgery">Jaw Surgery</option>
            <option value="denture_prostho">Denture (Prostho)</option>
            <option value="rootcanal_crowns">Root Canal & Crowns</option>
            <option value="other">Other</option>
          </select>
        </div>

          <div class="mb-3">
            <label class="form-label"><strong>Due Money:</strong></label>
            <input type="text" class="form-control" value="₹${dueMoney}" readonly style="background: rgba(255,255,255,0.1);">
          </div>
        </div>
      </form>
    `;
    
    document.getElementById('cancelEditBtn').addEventListener('click', function() {
      showDetails(index);
    });
    
    document.getElementById('editPatientForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      const mobileNo = formData.get('contactNo');
      if (mobileNo && !/^[6-9][0-9]{9}$/.test(mobileNo)) {
        alert('Mobile number must be exactly 10 digits starting with 6, 7, 8, or 9');
        return;
      }
      
      const startDate = formData.get('treatmentStart');
      if (startDate && !validateDate(startDate)) {
        alert('Treatment start date must be within the last 3 years');
        return;
      }
      
      const totalFee = parseFloat(formData.get('totalFee')) || 0;
      const paidFees = parseFloat(formData.get('paidFees')) || 0;
      
      if (paidFees > totalFee) {
        alert('Paid Fees cannot be greater than Total Fee.');
        return;
      }

      const updatedData = {
        name: formData.get('name'),
        contactNo: formData.get('contactNo'),
        email: formData.get('email'),
        patientDescription: formData.get('patientDescription'),
        treatmentStart: formData.get('treatmentStart'),
        totalFee: totalFee,
        paidFees: paidFees,
        patientType: formData.get('treatmentType') 
      };

      const updated = await updatePatient(p.id, updatedData);
      if (updated) {
        await loadPatients();
        const newIndex = patients.findIndex(patient => patient.id === p.id);
        showDetails(newIndex);
      }
    });
  }

  const treatmentType = document.getElementById('treatmentType');
  const otherTreatmentType = document.getElementById('otherTreatmentType');

  treatmentType.addEventListener('change', function() {
    if (this.value === 'other') {
      otherTreatmentType.style.display = 'block';
      otherTreatmentType.required = true;
    } else {
      otherTreatmentType.style.display = 'none';
      otherTreatmentType.required = false;
      otherTreatmentType.value = '';
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const mobileNo = form.contactNo.value;
    if (!/^[6-9][0-9]{9}$/.test(mobileNo)) {
      alert('Mobile number must be exactly 10 digits starting with 6, 7, 8, or 9');
      return;
    }
    
    const startDate = form.treatmentStart.value;
    if (!validateDate(startDate)) {
      alert('Treatment start date must be within the last 3 years');
      return;
    }
    
    let selectedTreatment = form.treatmentType.value;
    if(selectedTreatment === 'other') {
      selectedTreatment = otherTreatmentType.value.trim() || 'Other';
    }
    
    const totalFee = parseFloat(form.totalFee.value) || 0;
    const paidFees = parseFloat(form.paidFees.value) || 0;

    if (paidFees > totalFee) {
      alert('Paid Fees cannot be greater than Total Fee.');
      return;
    }

    const newPatient = {
      name: form.name.value.trim(),
      contactNo: mobileNo,
      email: form.email.value.trim(),
      patientDescription: form.patientDescription.value.trim(),
      treatmentStart: startDate,
      totalFee: totalFee,
      paidFees: paidFees,
      patientType: selectedTreatment
    };

    const created = await createPatient(newPatient);
    if (created) {
      await loadPatients();
      form.reset();
      otherTreatmentType.style.display = 'none';
      otherTreatmentType.required = false;
      form.style.display = 'none';
      showAddPatientBtn.style.display = 'inline-block';
    }
  });

  document.getElementById('searchBtn').addEventListener('click', () => {
    const q = searchInput.value.trim().toLowerCase();
    if(!q) return;
    const filtered = patients.filter(p => p.name.toLowerCase().includes(q));
    renderList(filtered);
  });

  document.getElementById('showAllBtn').addEventListener('click', () => {
    searchInput.value = '';
    renderList(patients);
  });

  const showAddPatientBtn = document.getElementById('showAddPatientBtn');
  const cancelAddPatientBtn = document.getElementById('cancelAddPatientBtn');

  showAddPatientBtn.addEventListener('click', function() {
    form.style.display = 'block';
    showAddPatientBtn.style.display = 'none';
  });

  cancelAddPatientBtn.addEventListener('click', function() {
    form.reset();
    form.style.display = 'none';
    showAddPatientBtn.style.display = 'inline-block';
    otherTreatmentType.style.display = 'none';
    otherTreatmentType.required = false;
  });
</script>

<script>
async function fetchPatients() {
  try {
    console.log('🔄 Fetching patients...');
    
    const response = await fetch('/api/patients', {
      method: 'GET',
      credentials: 'include', // Important for sessions
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    console.log('📡 Response status:', response.status);
    console.log('📡 Response ok:', response.ok);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('📊 Received data:', data);
    console.log('📊 Data type:', Array.isArray(data) ? 'Array' : typeof data);
    console.log('📊 Data length:', data.length);
    
    // Update your table/display here
    return data;
    
  } catch (error) {
    console.error('❌ Fetch error:', error);
  }
}
</script>

<script>
function submitPatientForm() {
  const patientData = {
    name: document.getElementById('patientName').value,
    contactno: document.getElementById('mobile').value,
    email: document.getElementById('email').value,
    patienttype: document.getElementById('treatmentType').value,
    patientdescription: document.getElementById('description').value,
    treatmentstart: document.getElementById('startDate').value,
    totalfee: parseInt(document.getElementById('totalFee').value) || 0,
    paidfees: parseInt(document.getElementById('paidFees').value) || 0
  };

  console.log('📤 Submitting patient data:', patientData);

  fetch('/api/patients', {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(patientData)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('✅ Patient added successfully:', data);
    // Optionally reload patients or update UI
    loadPatients();
  })
  .catch(error => {
    console.error('❌ Error adding patient:', error);
  });
}
</script>

</body>
</html>
